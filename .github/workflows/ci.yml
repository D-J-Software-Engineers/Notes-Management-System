name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: notes_admin
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: notes_management_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    strategy:
      matrix:
        node-version: [20]

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Check code formatting with Prettier
      - name: Check code formatting
        run: npm run format:check

      # 5. Security vulnerability scan
      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      # 6. Run linting if available
      - name: Run lint
        run: npm run lint --if-present
        continue-on-error: true

      # 7. Create required directories
      - name: Create required directories
        run: |
          mkdir -p uploads
          chmod 755 uploads

      # 8. Setup environment variables for tests
      - name: Create test .env file
        run: |
          cat > .env << EOF
          NODE_ENV=test
          PORT=5000
          DB_HOST=localhost
          DB_PORT=5432
          DB_NAME=notes_management_test
          DB_USER=notes_admin
          DB_PASSWORD=test_password
          JWT_SECRET=test_jwt_secret_key_for_ci
          JWT_EXPIRE=7d
          MAX_FILE_SIZE=10485760
          UPLOAD_PATH=./uploads
          ADMIN_EMAIL=admin@test.com
          ADMIN_PASSWORD=Admin@123
          EOF

      # 9. Validate environment variables
      - name: Validate environment
        run: |
          node -e "
          const required = ['DB_HOST', 'DB_NAME', 'DB_USER', 'DB_PASSWORD', 'JWT_SECRET'];
          const missing = required.filter(key => !process.env[key]);
          if (missing.length) {
            console.error('❌ Missing required environment variables:', missing);
            process.exit(1);
          }
          console.log('✅ All required environment variables are set');
          "

      # 10. Test database connection
      - name: Test database connection
        run: |
          node -e "
          const { Sequelize } = require('sequelize');
          const sequelize = new Sequelize(
            process.env.DB_NAME,
            process.env.DB_USER,
            process.env.DB_PASSWORD,
            {
              host: process.env.DB_HOST,
              port: process.env.DB_PORT,
              dialect: 'postgres',
              logging: false
            }
          );
          sequelize.authenticate()
            .then(() => {
              console.log('✅ Database connection successful');
              return sequelize.close();
            })
            .then(() => process.exit(0))
            .catch(err => {
              console.error('❌ Database connection failed:', err.message);
              process.exit(1);
            });
          "
        env:
          NODE_ENV: test

      # 11. Run database migrations/setup
      - name: Setup database
        run: npm run seed
        env:
          NODE_ENV: test

      # 12. Verify server can start
      - name: Verify server starts
        run: |
          timeout 10s npm start &
          SERVER_PID=$!
          sleep 5
          if ps -p $SERVER_PID > /dev/null; then
            echo "✅ Server started successfully"
            kill $SERVER_PID
            exit 0
          else
            echo "❌ Server failed to start"
            exit 1
          fi
        env:
          NODE_ENV: test

      # 13. Run tests
      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test

      # 14. Upload coverage reports (optional)
      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          if-no-files-found: ignore
