<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - Nsoma Digilib</title>
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/student.css" />
  </head>

  <body>
    <!-- Top navigation styled by student.css -->
    <nav class="student-nav">
      <div class="nav-container">
        <h1 class="nav-logo">üìö Nsoma Digilib</h1>
        <div class="nav-user">
          <span id="studentNameNav">Student</span>
          <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>
      </div>
    </nav>

    <div class="student-container">
      <!-- Sidebar -->
      <aside class="student-sidebar">
        <ul class="sidebar-menu">
          <li>
            <a href="#" class="sidebar-link active" data-tab="dashboard"
              >üè† Dashboard</a
            >
          </li>
          <li>
            <a href="#" class="sidebar-link" data-tab="notes">üìù Notes</a>
          </li>
          <li>
            <a href="#" class="sidebar-link" data-tab="resources"
              >üîó Resources</a
            >
          </li>
          <li>
            <a href="#" class="sidebar-link" data-tab="profile">üë§ Profile</a>
          </li>
        </ul>
      </aside>

      <!-- Main content -->
      <main class="student-main" id="studentMain">
        <!-- Dashboard tab -->
        <section id="dashboardTab" class="tab-content">
          <div class="student-info-card">
            <h3>Your Status</h3>
            <div class="info-grid">
              <div class="info-item">
                <strong>Name:</strong>
                <div id="studentName">-</div>
              </div>
              <div class="info-item">
                <strong>Level:</strong>
                <div id="studentLevel">-</div>
              </div>
              <div class="info-item">
                <strong>Class:</strong>
                <div id="studentClass">-</div>
              </div>
              <div class="info-item">
                <strong>Combination:</strong>
                <div id="studentCombination">-</div>
              </div>
              <div class="info-item">
                <strong>Account Status:</strong>
                <div id="studentStatus">-</div>
              </div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <h3>Available Notes</h3>
              <p class="stat-number" id="notesCount">0</p>
            </div>
            <div class="stat-card">
              <h3>Available Resources</h3>
              <p class="stat-number" id="resourcesCount">0</p>
            </div>
          </div>
        </section>

        <!-- Notes tab -->
        <section id="notesTab" class="tab-content" style="display: none">
          <!-- Subject View (Level 1) -->
          <div id="notesSubjectView">
            <div class="section-header">
              <h2>Your Subjects</h2>
              <p class="section-subtitle">Select a subject to view notes</p>
            </div>
            <div id="notesSubjectContainer" class="notes-grid">
              <!-- Subject Cards will be injected here -->
            </div>
          </div>

          <!-- Notes List View (Level 2) -->
          <div id="notesListView" style="display: none">
            <div class="section-header">
              <div>
                <button
                  class="btn-sm btn-secondary"
                  id="backToNotesSubjectsBtn"
                >
                  ‚Üê Back to Subjects
                </button>
                <h2 style="margin-top: 10px">
                  Notes: <span id="currentSubjectTitle"></span>
                </h2>
              </div>
              <div class="filters">
                <input
                  type="text"
                  id="notesSearch"
                  placeholder="Search notes in this subject..."
                />
              </div>
            </div>
            <div id="notesContainer" class="notes-grid"></div>
          </div>
        </section>

        <!-- Resources tab -->
        <section id="resourcesTab" class="tab-content" style="display: none">
          <!-- Subject View (Level 1) -->
          <div id="resourcesSubjectView">
            <div class="section-header">
              <h2>Resource Subjects</h2>
              <p class="section-subtitle">Select a subject to view resources</p>
            </div>
            <div id="resourcesSubjectContainer" class="notes-grid">
              <!-- Subject Cards injected here -->
            </div>
          </div>

          <!-- Resources List View (Level 2) -->
          <div id="resourcesListView" style="display: none">
            <div class="section-header">
              <div>
                <button
                  class="btn-sm btn-secondary"
                  id="backToResourcesSubjectsBtn"
                >
                  ‚Üê Back to Subjects
                </button>
                <h2 style="margin-top: 10px">
                  Resources: <span id="currentResourceSubjectTitle"></span>
                </h2>
              </div>
            </div>
            <div id="resourcesContainer" class="notes-grid"></div>
          </div>
        </section>

        <!-- Profile tab -->
        <section id="profileTab" class="tab-content" style="display: none">
          <div class="profile-card">
            <div class="profile-info">
              <h3>Your Profile</h3>
              <p><strong>Name:</strong> <span id="profileName">-</span></p>
              <p><strong>Email:</strong> <span id="profileEmail">-</span></p>
              <p><strong>Level:</strong> <span id="profileLevel">-</span></p>
              <p><strong>Class:</strong> <span id="profileClass">-</span></p>
              <p>
                <strong>Combination:</strong>
                <span id="profileCombination">-</span>
              </p>
              <p>
                <strong>Status:</strong>
                <span id="profileStatus">-</span>
              </p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/auth.js"></script>

    <script>
      let allNotes = [];
      let allResources = [];
      let currentNotesSubject = null;

      document.addEventListener("DOMContentLoaded", async () => {
        const user = await getCurrentUser();
        if (!user || user.role !== "student") {
          // Not a student or not logged in
          logout();
          return;
        }

        // Fill basic info
        document.getElementById("studentNameNav").textContent = user.name;
        document.getElementById("studentName").textContent = user.name;
        document.getElementById("studentLevel").textContent = user.level || "-";
        document.getElementById("studentClass").textContent = (
          user.class || "-"
        ).toUpperCase();
        document.getElementById("studentCombination").textContent =
          user.combination || "-";

        const statusText = user.isConfirmed ? "Confirmed" : "Pending Approval";
        document.getElementById("studentStatus").textContent = statusText;

        // Profile tab info
        document.getElementById("profileName").textContent = user.name;
        document.getElementById("profileEmail").textContent = user.email;
        document.getElementById("profileLevel").textContent = user.level || "-";
        document.getElementById("profileClass").textContent = (
          user.class || "-"
        ).toUpperCase();
        document.getElementById("profileCombination").textContent =
          user.combination || "-";
        document.getElementById("profileStatus").textContent = statusText;

        // Logout button
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            logout();
          });
        }

        // Sidebar tab switching
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const tab = link.getAttribute("data-tab");
            switchTab(tab);
          });
        });

        // Notes search
        const notesSearch = document.getElementById("notesSearch");
        if (notesSearch) {
          notesSearch.addEventListener(
            "input",
            debounce((e) => filterNotes(e.target.value), 300),
          );
        }

        // Global click handlers for notes
        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("view-note-btn")) {
            const noteId = e.target.getAttribute("data-note-id");
            viewNote(noteId);
          } else if (e.target.classList.contains("subject-card")) {
            const subject = e.target.getAttribute("data-subject");
            const type = e.target.getAttribute("data-type"); // 'notes' or 'resources'
            if (type === "notes") {
              openNotesSubject(subject);
            } else if (type === "resources") {
              openResourcesSubject(subject);
            }
          } else if (e.target.closest(".subject-card")) {
            // Handle click on child elements of subject card
            const card = e.target.closest(".subject-card");
            const subject = card.getAttribute("data-subject");
            const type = card.getAttribute("data-type");
            if (type === "notes") {
              openNotesSubject(subject);
            } else if (type === "resources") {
              openResourcesSubject(subject);
            }
          }
        });

        // Load notes and resources for this student (filtered by level, class, combination)
        await loadNotesForStudent(user);
        await loadResourcesForStudent(user);

        // Back buttons
        const backToNotesBtn = document.getElementById(
          "backToNotesSubjectsBtn",
        );
        if (backToNotesBtn) {
          backToNotesBtn.addEventListener("click", showNotesSubjects);
        }

        const backToResourcesBtn = document.getElementById(
          "backToResourcesSubjectsBtn",
        );
        if (backToResourcesBtn) {
          backToResourcesBtn.addEventListener("click", showResourcesSubjects);
        }
      });

      function switchTab(tab) {
        document
          .querySelectorAll(".sidebar-link")
          .forEach((l) => l.classList.remove("active"));
        const activeLink = document.querySelector(
          `.sidebar-link[data-tab="${tab}"]`,
        );
        if (activeLink) activeLink.classList.add("active");

        document
          .querySelectorAll(".tab-content")
          .forEach((section) => (section.style.display = "none"));

        const tabEl = document.getElementById(
          tab === "dashboard" ? "dashboardTab" : `${tab}Tab`,
        );
        if (tabEl) tabEl.style.display = "block";
      }

      // ==========================================
      // NOTES LOGIC
      // ==========================================

      async function loadNotesForStudent(user) {
        try {
          // 1. Fetch Official Subjects for this student's level/class
          const subjectParams = new URLSearchParams();
          if (user.level) subjectParams.append("level", user.level);
          if (user.class) subjectParams.append("class", user.class);

          let subjectsRes = await authFetch(
            `${API_BASE}/subjects?${subjectParams.toString()}`,
            {
              headers: { Authorization: `Bearer ${getToken()}` },
            },
          );

          let officialSubjects = [];
          if (subjectsRes.ok) {
            const subjectData = await subjectsRes.json();
            officialSubjects = subjectData.data || [];
          }

          // 2. Fetch Notes
          const params = new URLSearchParams();
          if (user.level) params.append("level", user.level);
          if (user.class) params.append("class", user.class);
          if (user.combination) params.append("combination", user.combination);
          params.append("limit", "100");

          let url = `${API_BASE}/notes`;
          const query = params.toString();
          if (query) url += "?" + query;

          const res = await authFetch(url, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });

          if (!res.ok) {
            if (res.status === 401) {
              removeToken();
              window.location.href = "/pages/login.html";
              return;
            }
            throw new Error("Failed to load notes");
          }

          const data = await res.json();
          allNotes = data.data || [];
          document.getElementById("notesCount").textContent = allNotes.length;

          renderNoteSubjects(allNotes, officialSubjects);
        } catch (err) {
          console.error("Failed to load notes", err);
          document.getElementById("notesSubjectContainer").innerHTML =
            '<div class="no-data">Could not load notes.</div>';
        }
      }

      function renderNoteSubjects(notes, officialSubjects) {
        const container = document.getElementById("notesSubjectContainer");
        if (!container) return;

        // Create a map of normalized subject names to official display names
        // e.g., "mathematics" -> "Mathematics"
        const normalizedOfficial = {};
        officialSubjects.forEach((s) => {
          normalizedOfficial[s.name.trim().toLowerCase()] = s.name;
        });

        // Group notes by subject
        const notesBySubject = {};

        notes.forEach((note) => {
          const rawSubj = note.subject || "General";
          const normSubj = rawSubj.trim().toLowerCase();

          // Use official name if exists, otherwise title case the raw one or keep as is
          // We really want to group "Mathematics" and "mathematics" together under "Mathematics"
          let displaySubj = normalizedOfficial[normSubj];

          if (!displaySubj) {
            // If not found in official list, just use the raw subject but maybe capitalize it for display consistency?
            // Or use the raw subject as the key.
            // If we have "Biology" and "biology" in notes but NO official subject "Biology", they should still group.
            // So we need a map of norm -> display for non-official too.
            displaySubj = rawSubj; // fallback
          }

          // We use the NORMALIZED key for counting, but we need to store the display name
          if (!notesBySubject[normSubj]) {
            notesBySubject[normSubj] = { count: 0, displayName: displaySubj };
          }
          notesBySubject[normSubj].count++;

          // Update display name if we found a "better" one (e.g. from official)
          if (normalizedOfficial[normSubj]) {
            notesBySubject[normSubj].displayName = normalizedOfficial[normSubj];
          }
        });

        // Prepare list of subjects to display
        // 1. All Official Subjects (even if 0 notes, if that's desired? User said "linked to subjects we fill in... containing ALL notes")
        // Let's show official subjects.

        const distinctSubjects = new Set();

        // Add official subjects first
        officialSubjects.forEach((s) => {
          distinctSubjects.add(s.name.trim().toLowerCase());
        });

        // Add any other subjects found in notes
        Object.keys(notesBySubject).forEach((norm) => {
          distinctSubjects.add(norm);
        });

        const sortedKeys = [...distinctSubjects].sort();

        if (sortedKeys.length === 0) {
          container.innerHTML =
            '<div class="no-data">No subjects available for your class.</div>';
          return;
        }

        container.innerHTML = sortedKeys
          .map((normKey) => {
            // Get display name: either from official list, or from our notes grouping
            let displayName = normalizedOfficial[normKey];
            let count = 0;

            if (notesBySubject[normKey]) {
              count = notesBySubject[normKey].count;
              if (!displayName)
                displayName = notesBySubject[normKey].displayName;
            }

            if (!displayName) {
              // Fallback if it was in official list but no notes, or some other edge case
              // Try to find it in official list again
              const official = officialSubjects.find(
                (s) => s.name.trim().toLowerCase() === normKey,
              );
              displayName = official
                ? official.name
                : normKey.charAt(0).toUpperCase() + normKey.slice(1);
            }

            return `
            <article class="note-card subject-card" data-subject="${displayName}" data-type="notes" style="cursor: pointer; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                <h3>${displayName}</h3>
                <span class="note-badge" style="margin-top: 0.5rem;">${count} Notes</span>
            </article>
          `;
          })
          .join("");
      }

      function openNotesSubject(subjectDisplay) {
        currentNotesSubject = subjectDisplay;
        document.getElementById("notesSubjectView").style.display = "none";
        document.getElementById("notesListView").style.display = "block";
        document.getElementById("currentSubjectTitle").textContent =
          subjectDisplay;

        // Filter notes for this subject (case-insensitive)
        // subjectDisplay is the "Nice Name" e.g. "Biology"
        // We want to find notes where normalized(note.subject) == normalized(subjectDisplay)
        const targetNorm = subjectDisplay.trim().toLowerCase();

        const filtered = allNotes.filter((n) => {
          const noteSubj = (n.subject || "General").trim().toLowerCase();
          return noteSubj === targetNorm;
        });

        renderNotesList(filtered);
      }

      function showNotesSubjects() {
        document.getElementById("notesListView").style.display = "none";
        document.getElementById("notesSubjectView").style.display = "block";
        currentNotesSubject = null;
        // Clear search
        const searchInput = document.getElementById("notesSearch");
        if (searchInput) searchInput.value = "";
      }

      function renderNotesList(notes) {
        const container = document.getElementById("notesContainer");
        if (!container) return;

        if (!notes.length) {
          container.innerHTML = '<div class="no-data">No notes found.</div>';
          return;
        }

        container.innerHTML = notes
          .map(
            (note) => `
            <article class="note-card">
              <div class="note-header">
                <h3>${note.title}</h3>
                <!-- Subject is already known in this view, so maybe show type/date -->
                <span class="note-badge">${formatDate(note.createdAt)}</span>
              </div>
              <p class="note-description">
                ${note.description || "No description provided."}
              </p>
              <div class="note-meta">
                 <span>${note.getReadableFileSize ? note.getReadableFileSize() : ""}</span>
              </div>
              <div class="note-actions">
                <button
                  class="btn-sm btn-primary view-note-btn"
                  data-note-id="${note.id}"
                  style="width: 100%;"
                >
                  View Note
                </button>
              </div>
            </article>
          `,
          )
          .join("");
      }

      function filterNotes(term) {
        if (!currentNotesSubject) return; // Only filter when inside a subject

        const q = term.trim().toLowerCase();
        // pre-filter by current subject
        const targetNorm = currentNotesSubject.trim().toLowerCase();
        const subjectNotes = allNotes.filter(
          (n) => (n.subject || "General").trim().toLowerCase() === targetNorm,
        );

        if (!q) {
          renderNotesList(subjectNotes);
          return;
        }

        const filtered = subjectNotes.filter((note) => {
          return (
            (note.title && note.title.toLowerCase().includes(q)) ||
            (note.description && note.description.toLowerCase().includes(q))
          );
        });

        renderNotesList(filtered);
      }

      // ==========================================
      // RESOURCES LOGIC
      // ==========================================

      async function loadResourcesForStudent(user) {
        try {
          // 1. Fetch Official Subjects
          const subjectParams = new URLSearchParams();
          if (user.level) subjectParams.append("level", user.level);
          if (user.class) subjectParams.append("class", user.class);

          let subjectsRes = await authFetch(
            `${API_BASE}/subjects?${subjectParams.toString()}`,
            {
              headers: { Authorization: `Bearer ${getToken()}` },
            },
          );

          let officialSubjects = [];
          if (subjectsRes.ok) {
            const subjectData = await subjectsRes.json();
            officialSubjects = subjectData.data || [];
          }

          // 2. Fetch Resources
          const params = new URLSearchParams();
          if (user.level) params.append("level", user.level);
          if (user.class) params.append("class", user.class);
          if (user.combination) params.append("combination", user.combination);
          params.append("limit", "100");

          let url = `${API_BASE}/resources`;
          const query = params.toString();
          if (query) url += "?" + query;

          const res = await authFetch(url, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });

          if (!res.ok) throw new Error("Failed");

          const data = await res.json();
          allResources = data.data || [];
          document.getElementById("resourcesCount").textContent =
            allResources.length;

          renderResourceSubjects(allResources, officialSubjects);
        } catch (err) {
          console.error("Failed to load resources", err);
          document.getElementById("resourcesSubjectContainer").innerHTML =
            '<div class="no-data">Could not load resources.</div>';
        }
      }

      function renderResourceSubjects(resources, officialSubjects) {
        const container = document.getElementById("resourcesSubjectContainer");
        if (!container) return;

        const normalizedOfficial = {};
        officialSubjects.forEach((s) => {
          normalizedOfficial[s.name.trim().toLowerCase()] = s.name;
        });

        const resourcesBySubject = {};
        resources.forEach((r) => {
          const rawSubj = r.subject || "General";
          const normSubj = rawSubj.trim().toLowerCase();

          let displaySubj = normalizedOfficial[normSubj];
          if (!displaySubj) displaySubj = rawSubj;

          if (!resourcesBySubject[normSubj]) {
            resourcesBySubject[normSubj] = {
              count: 0,
              displayName: displaySubj,
            };
          }
          resourcesBySubject[normSubj].count++;

          if (normalizedOfficial[normSubj]) {
            resourcesBySubject[normSubj].displayName =
              normalizedOfficial[normSubj];
          }
        });

        const distinctSubjects = new Set();
        officialSubjects.forEach((s) => {
          distinctSubjects.add(s.name.trim().toLowerCase());
        });
        Object.keys(resourcesBySubject).forEach((norm) => {
          distinctSubjects.add(norm);
        });

        const sortedKeys = [...distinctSubjects].sort();

        if (sortedKeys.length === 0) {
          container.innerHTML =
            '<div class="no-data">No resources available.</div>';
          return;
        }

        container.innerHTML = sortedKeys
          .map((normKey) => {
            let displayName = normalizedOfficial[normKey];
            let count = 0;

            if (resourcesBySubject[normKey]) {
              count = resourcesBySubject[normKey].count;
              if (!displayName)
                displayName = resourcesBySubject[normKey].displayName;
            }

            if (!displayName) {
              const official = officialSubjects.find(
                (s) => s.name.trim().toLowerCase() === normKey,
              );
              displayName = official
                ? official.name
                : normKey.charAt(0).toUpperCase() + normKey.slice(1);
            }

            return `
            <article class="note-card subject-card" data-subject="${displayName}" data-type="resources" style="cursor: pointer; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üîó</div>
                <h3>${displayName}</h3>
                <span class="note-badge" style="margin-top: 0.5rem;">${count} Resources</span>
            </article>
          `;
          })
          .join("");
      }

      function openResourcesSubject(subjectDisplay) {
        document.getElementById("resourcesSubjectView").style.display = "none";
        document.getElementById("resourcesListView").style.display = "block";
        document.getElementById("currentResourceSubjectTitle").textContent =
          subjectDisplay;

        const targetNorm = subjectDisplay.trim().toLowerCase();
        const filtered = allResources.filter(
          (r) => (r.subject || "General").trim().toLowerCase() === targetNorm,
        );

        const container = document.getElementById("resourcesContainer");
        container.innerHTML = filtered
          .map(
            (r) => `
             <article class="note-card resource-card">
              <div class="note-header">
                <h3>${r.title}</h3>
              </div>
              <p class="note-description">${r.description || "External link"}</p>
              <div class="note-actions">
                <a href="${r.url}" target="_blank" rel="noopener" class="btn-sm btn-primary" style="width: 100%; text-align: center;">
                  Open Link ‚Üí
                </a>
              </div>
            </article>
          `,
          )
          .join("");
      }

      function showResourcesSubjects() {
        document.getElementById("resourcesListView").style.display = "none";
        document.getElementById("resourcesSubjectView").style.display = "block";
      }

      // ==========================================
      // VIEW NOTE LOGIC
      // ==========================================

      function viewNote(id) {
        const token = getToken();
        if (!token) {
          window.location.href = "/pages/login.html";
          return;
        }
        // Direct open with token param
        const url = `${API_BASE}/notes/${id}/view?token=${token}`;
        window.open(url, "_blank", "noopener,noreferrer");
      }
    </script>
  </body>
</html>
